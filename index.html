<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CV Creator Platinum - Generatore PDF Professionale</title>
    
    <!-- Font & Icone -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@300;400;700&family=Roboto+Mono:wght@400&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        /* --- RESET & GLOBAL --- */
        :root {
            --primary: #2563eb;
            --bg-editor: #1e293b;
            --bg-panel: #0f172a;
            --text-editor: #e2e8f0;
            --border: #334155;
        }
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            overflow: hidden; /* App-like feel */
        }

        /* --- LAYOUT APP --- */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* --- SINISTRA: EDITOR --- */
        .editor-sidebar {
            width: 450px;
            background-color: var(--bg-editor);
            color: var(--text-editor);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            flex-shrink: 0;
            z-index: 20;
            box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        }

        .editor-header {
            padding: 20px;
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .brand { font-size: 1.2rem; font-weight: 700; color: #fff; letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; }
        .brand i { color: var(--primary); }

        .editor-tabs {
            display: flex;
            background-color: var(--bg-panel);
        }
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            color: #64748b;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab-btn.active { color: #fff; border-bottom-color: var(--primary); background: rgba(37, 99, 235, 0.1); }
        .tab-btn:hover { color: #cbd5e1; }

        .editor-content {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
        }
        .editor-content::-webkit-scrollbar { width: 6px; }
        .editor-content::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* --- DESTRA: PREVIEW --- */
        .preview-area {
            flex: 1;
            background-color: #cbd5e1;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: cover;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px;
            overflow: hidden;
        }

        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            padding: 8px 15px;
            border-radius: 30px;
            color: white;
            font-size: 12px;
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 100;
        }

        /* --- CONTENITORE CV A4 --- */
        #cv-render-target {
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transition: transform 0.2s ease;
            transform-origin: top center;
            background: white;
        }

        /* --- UI COMPONENTS --- */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.8rem; font-weight: 600; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input, textarea, select {
            width: 100%;
            background: #334155;
            border: 1px solid #475569;
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        .row { display: flex; gap: 15px; }
        .row > * { flex: 1; }

        /* Action Buttons */
        .action-bar {
            padding: 20px;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }
        .btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }
        .btn-secondary { background: #334155; color: white; }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; }

        /* Design Cards */
        .tpl-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .tpl-card {
            background: #334155;
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .tpl-card.active { border-color: var(--primary); background: #1e293b; }
        .tpl-preview { height: 60px; background: #475569; border-radius: 6px; margin-bottom: 8px; opacity: 0.5; }
        .tpl-card.active .tpl-preview { opacity: 1; background: #64748b; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 900px) {
            .app-container { flex-direction: column-reverse; height: auto; min-height: 100vh; overflow: visible; }
            .editor-sidebar { width: 100%; height: auto; border-right: none; border-top: 1px solid var(--border); }
            .preview-area { min-height: 60vh; padding: 20px; align-items: center; }
            body { overflow: auto; }
        }

        /* --- STILI DI STAMPA (CRITICO PER PDF) --- */
        @media print {
            body * { visibility: hidden; }
            #cv-render-target, #cv-render-target * { visibility: visible; }
            
            /* Reset Layout */
            .app-container { display: block; height: auto; overflow: visible; }
            .editor-sidebar, .preview-area, .zoom-controls { display: none; }
            
            /* Posizionamento A4 */
            #cv-render-target {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm !important;
                height: auto !important; /* Permetti multipagina se necessario */
                min-height: 297mm;
                margin: 0;
                padding: 0;
                box-shadow: none;
                transform: none !important; /* Rimuovi zoom */
                
                /* Forza stampa colori */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            @page { margin: 0; size: A4; }
        }

        /* --- CV STYLES (A4) --- */
        .cv-page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            color: #1f2937;
            box-sizing: border-box;
            position: relative;
            overflow: hidden; /* Importante per sfondi */
        }
        
        /* Liste dinamiche editor */
        .dynamic-item { background: #334155; padding: 15px; border-radius: 8px; margin-bottom: 10px; position: relative; border: 1px solid #475569; }
        .btn-del { position: absolute; top: 10px; right: 10px; color: #94a3b8; background: none; border: none; cursor: pointer; }
        .btn-del:hover { color: #ef4444; }
        .btn-add-sect { width: 100%; background: rgba(255,255,255,0.05); border: 1px dashed #64748b; color: #94a3b8; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
        .btn-add-sect:hover { background: rgba(255,255,255,0.1); color: #fff; }

    </style>
</head>
<body>

<div class="app-container">
    
    <!-- EDITOR (SINISTRA) -->
    <div class="editor-sidebar">
        <div class="editor-header">
            <div class="brand"><i class="fa-solid fa-file-invoice"></i> CV Platinum</div>
            <button class="btn btn-secondary" onclick="cvApp.reset()" style="padding: 5px 10px; font-size: 12px;">Reset</button>
        </div>

        <div class="editor-tabs">
            <button class="tab-btn active" onclick="cvApp.tab('content')">Contenuto</button>
            <button class="tab-btn" onclick="cvApp.tab('design')">Design</button>
        </div>

        <div class="editor-content">
            
            <!-- PANEL: CONTENT -->
            <div id="panel-content">
                
                <div class="form-group">
                    <label class="form-label">Foto Profilo</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div id="preview-photo" style="width: 50px; height: 50px; border-radius: 50%; background: #334155; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid #475569;">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <input type="file" id="upload-photo" accept="image/*" style="display: none;" onchange="cvApp.uploadPhoto(this)">
                        <button class="btn btn-secondary" onclick="document.getElementById('upload-photo').click()" style="padding: 8px 12px; font-size: 12px;">Carica</button>
                        <button class="btn btn-danger" onclick="cvApp.removePhoto()" style="padding: 8px 12px; font-size: 12px;">Rimuovi</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Chi sei</label>
                    <input type="text" data-model="personal.name" placeholder="Nome e Cognome">
                    <input type="text" data-model="personal.title" placeholder="Job Title (es. Graphic Designer)" style="margin-top: 10px;">
                </div>

                <div class="row">
                    <div class="form-group">
                        <label class="form-label">Contatti</label>
                        <input type="text" data-model="personal.email" placeholder="Email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <input type="text" data-model="personal.phone" placeholder="Telefono">
                    </div>
                </div>
                <input type="text" data-model="personal.location" placeholder="Città / Indirizzo" style="margin-bottom: 20px;">

                <div class="form-group">
                    <label class="form-label">Profilo (Bio)</label>
                    <textarea data-model="personal.summary" rows="4" placeholder="Breve descrizione professionale..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Esperienza Lavorativa</label>
                    <div id="list-experience"></div>
                    <button class="btn-add-sect" onclick="cvApp.addItem('experience')">+ Aggiungi Esperienza</button>
                </div>

                <div class="form-group">
                    <label class="form-label">Formazione</label>
                    <div id="list-education"></div>
                    <button class="btn-add-sect" onclick="cvApp.addItem('education')">+ Aggiungi Scuola</button>
                </div>

                <div class="form-group">
                    <label class="form-label">Lingue & Skills</label>
                    <textarea data-model="skills" rows="3" placeholder="Italiano (Madrelingua), Inglese (C1), Photoshop, Team work..."></textarea>
                </div>

            </div>

            <!-- PANEL: DESIGN -->
            <div id="panel-design" style="display: none;">
                
                <div class="form-group">
                    <label class="form-label">Layout</label>
                    <div class="tpl-grid">
                        <div class="tpl-card active" onclick="cvApp.setTemplate('modern', this)">
                            <div class="tpl-preview" style="background: linear-gradient(90deg, #444 30%, #666 30%);"></div>
                            <span>Moderno</span>
                        </div>
                        <div class="tpl-card" onclick="cvApp.setTemplate('classic', this)">
                            <div class="tpl-preview" style="background: #fff; border-top: 5px solid #444;"></div>
                            <span>Classico</span>
                        </div>
                        <div class="tpl-card" onclick="cvApp.setTemplate('minimal', this)">
                            <div class="tpl-preview" style="background: #fff;"></div>
                            <span>Minimal</span>
                        </div>
                        <div class="tpl-card" onclick="cvApp.setTemplate('elegant', this)">
                            <div class="tpl-preview" style="background: #e2e8f0; border-left: 15px solid #444;"></div>
                            <span>Elegante</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Colore Accento</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="cvApp.setColor('#2563eb')" style="width: 30px; height: 30px; border-radius: 50%; background: #2563eb; border: 2px solid white; cursor: pointer;"></button>
                        <button onclick="cvApp.setColor('#059669')" style="width: 30px; height: 30px; border-radius: 50%; background: #059669; border: 2px solid white; cursor: pointer;"></button>
                        <button onclick="cvApp.setColor('#dc2626')" style="width: 30px; height: 30px; border-radius: 50%; background: #dc2626; border: 2px solid white; cursor: pointer;"></button>
                        <button onclick="cvApp.setColor('#0f172a')" style="width: 30px; height: 30px; border-radius: 50%; background: #0f172a; border: 2px solid white; cursor: pointer;"></button>
                        <button onclick="cvApp.setColor('#7c3aed')" style="width: 30px; height: 30px; border-radius: 50%; background: #7c3aed; border: 2px solid white; cursor: pointer;"></button>
                        <input type="color" onchange="cvApp.setColor(this.value)" style="width: 30px; height: 30px; border-radius: 50%; padding: 0; border: 2px solid white; cursor: pointer;">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Font</label>
                    <select onchange="cvApp.setFont(this.value)">
                        <option value="'Inter', sans-serif">Inter (Standard Web)</option>
                        <option value="'Poppins', sans-serif">Poppins (Moderno)</option>
                        <option value="'Merriweather', serif">Merriweather (Classico)</option>
                        <option value="'Roboto Mono', monospace">Roboto Mono (Tech)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Dimensione Testo</label>
                    <input type="range" min="0.8" max="1.2" step="0.05" value="1" oninput="cvApp.setScale(this.value)">
                </div>

            </div>

        </div>

        <div class="action-bar">
            <button class="btn btn-primary" onclick="window.print()">
                <i class="fa-solid fa-download"></i> Scarica PDF
            </button>
        </div>
    </div>

    <!-- PREVIEW AREA (DESTRA) -->
    <div class="preview-area" id="preview-container">
        
        <div class="zoom-controls">
            <i class="fa-solid fa-magnifying-glass"></i>
            <span id="zoom-level">Auto Fit</span>
        </div>

        <!-- FOGLIO A4 -->
        <div id="cv-render-target" class="cv-page">
            <!-- Il contenuto viene generato via JS -->
        </div>

    </div>

</div>

<!-- LOGICA APP -->
<script>
const cvApp = {
    data: {
        personal: { name: 'Mario Rossi', title: 'Digital Marketing Manager', email: 'mario@example.com', phone: '+39 333 1234567', location: 'Milano', summary: 'Professionista con oltre 5 anni di esperienza nella gestione di campagne digitali e team creativi. Appassionato di dati e risultati.' },
        experience: [{ id: 1, role: 'Senior Manager', company: 'Tech Agency', start: '2020', end: 'Oggi', desc: 'Gestione budget 50k/mese. Coordinamento team di 5 persone.' }],
        education: [{ id: 1, degree: 'Laurea in Economia', school: 'Università Bocconi', year: '2019' }],
        skills: 'SEO, SEM, Google Analytics, Leadership, Inglese C1',
        photo: null,
        config: { template: 'modern', color: '#2563eb', font: "'Inter', sans-serif", scale: 1 }
    },

    init: function() {
        this.load();
        this.bindEvents();
        this.renderLists();
        this.updatePhoto();
        this.render();
        
        // Auto-Zoom Observer
        new ResizeObserver(() => this.autoZoom()).observe(document.getElementById('preview-container'));
        setTimeout(() => this.autoZoom(), 200);
    },

    // --- RENDER ENGINE ---
    render: function() {
        const d = this.data;
        const c = d.config.color;
        const f = d.config.font;
        const s = d.config.scale;
        
        // CSS Variables injection for cleaner templates
        const style = `font-family: ${f}; font-size: ${14 * s}px; color: #333; line-height: 1.5; height: 100%;`;
        const photoHtml = d.photo ? `<div style="width:120px; height:120px; background-image:url('${d.photo}'); background-size:cover; background-position:center; border-radius:50%; margin-bottom:20px; border:4px solid rgba(255,255,255,0.2);"></div>` : '';

        let html = '';

        /* --- TEMPLATE MODERN (Sidebar Left) --- */
        if (d.config.template === 'modern') {
            html = `
            <div style="${style} display: flex;">
                <div style="width: 35%; background: ${c}; color: white; padding: 40px 25px; display: flex; flex-direction: column;">
                    <div style="text-align: center; margin-bottom: 40px;">
                        ${d.photo ? `<div style="width:120px; height:120px; margin:0 auto 20px; background-image:url('${d.photo}'); background-size:cover; background-position:center; border-radius:50%; border:4px solid rgba(255,255,255,0.3);"></div>` : ''}
                        <h1 style="font-size: 1.8em; font-weight: 700; line-height: 1.2; margin-bottom: 5px;">${d.personal.name}</h1>
                        <p style="opacity: 0.9; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px;">${d.personal.title}</p>
                    </div>
                    
                    <div style="margin-bottom: 40px; font-size: 0.9em; line-height: 2;">
                        <div style="border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; margin-bottom: 15px; font-weight: 600; text-transform: uppercase;">Contatti</div>
                        <div><i class="fa-solid fa-envelope" style="width: 20px;"></i> ${d.personal.email}</div>
                        <div><i class="fa-solid fa-phone" style="width: 20px;"></i> ${d.personal.phone}</div>
                        <div><i class="fa-solid fa-location-dot" style="width: 20px;"></i> ${d.personal.location}</div>
                    </div>

                    <div style="margin-top: auto;">
                        <div style="border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; margin-bottom: 15px; font-weight: 600; text-transform: uppercase;">Competenze</div>
                        <p style="font-size: 0.9em; line-height: 1.6; opacity: 0.9;">${d.skills}</p>
                    </div>
                </div>
                
                <div style="flex: 1; padding: 40px; background: white;">
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: ${c}; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid ${c}33; padding-bottom: 10px; margin-bottom: 15px;">Profilo</h3>
                        <p style="color: #555;">${d.personal.summary}</p>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="color: ${c}; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid ${c}33; padding-bottom: 10px; margin-bottom: 15px;">Esperienza</h3>
                        ${d.experience.map(e => `
                            <div style="margin-bottom: 20px;">
                                <h4 style="font-weight: 700; font-size: 1.1em; margin-bottom: 2px;">${e.role}</h4>
                                <div style="color: ${c}; font-weight: 600; font-size: 0.9em; margin-bottom: 5px;">${e.company} | ${e.start} - ${e.end}</div>
                                <p style="font-size: 0.95em; color: #555;">${e.desc}</p>
                            </div>
                        `).join('')}
                    </div>

                    <div>
                        <h3 style="color: ${c}; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid ${c}33; padding-bottom: 10px; margin-bottom: 15px;">Formazione</h3>
                        ${d.education.map(e => `
                            <div style="margin-bottom: 15px;">
                                <div style="font-weight: 700;">${e.degree}</div>
                                <div style="color: #666; font-size: 0.9em;">${e.school}, ${e.year}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
        }

        /* --- TEMPLATE CLASSIC (Top Header) --- */
        else if (d.config.template === 'classic') {
            html = `
            <div style="${style} padding: 50px;">
                <div style="text-align: center; border-bottom: 2px solid ${c}; padding-bottom: 30px; margin-bottom: 40px;">
                    ${d.photo ? `<div style="width:100px; height:100px; margin:0 auto 15px; background-image:url('${d.photo}'); background-size:cover; background-position:center; border-radius:50%;"></div>` : ''}
                    <h1 style="font-size: 2.5em; text-transform: uppercase; letter-spacing: 2px; color: #222; margin-bottom: 5px;">${d.personal.name}</h1>
                    <p style="color: ${c}; font-size: 1.2em; font-weight: 500;">${d.personal.title}</p>
                    <div style="margin-top: 15px; font-size: 0.9em; color: #666;">
                        ${d.personal.email} • ${d.personal.phone} • ${d.personal.location}
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <h3 style="background: #f8fafc; padding: 8px 15px; border-left: 4px solid ${c}; text-transform: uppercase; font-size: 1em; letter-spacing: 1px; margin-bottom: 15px;">Profilo</h3>
                    <p style="color: #444; text-align: justify;">${d.personal.summary}</p>
                </div>

                <div style="margin-bottom: 30px;">
                    <h3 style="background: #f8fafc; padding: 8px 15px; border-left: 4px solid ${c}; text-transform: uppercase; font-size: 1em; letter-spacing: 1px; margin-bottom: 15px;">Esperienza</h3>
                    ${d.experience.map(e => `
                        <div style="display: flex; margin-bottom: 20px;">
                            <div style="width: 140px; font-weight: 600; color: ${c}; font-size: 0.9em; flex-shrink: 0; padding-top: 3px;">${e.start} - ${e.end}</div>
                            <div>
                                <h4 style="font-weight: 700; margin-bottom: 3px; font-size: 1.1em;">${e.role}</h4>
                                <div style="font-style: italic; color: #666; margin-bottom: 5px; font-size: 0.9em;">${e.company}</div>
                                <p style="color: #444; font-size: 0.95em;">${e.desc}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div style="display: flex; gap: 40px;">
                    <div style="flex: 1;">
                        <h3 style="background: #f8fafc; padding: 8px 15px; border-left: 4px solid ${c}; text-transform: uppercase; font-size: 1em; letter-spacing: 1px; margin-bottom: 15px;">Istruzione</h3>
                        ${d.education.map(e => `
                            <div style="margin-bottom: 15px;">
                                <div style="font-weight: 700;">${e.degree}</div>
                                <div style="font-size: 0.9em; color: #666;">${e.school}, ${e.year}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="flex: 1;">
                        <h3 style="background: #f8fafc; padding: 8px 15px; border-left: 4px solid ${c}; text-transform: uppercase; font-size: 1em; letter-spacing: 1px; margin-bottom: 15px;">Skills</h3>
                        <p style="color: #444;">${d.skills}</p>
                    </div>
                </div>
            </div>`;
        }

        /* --- TEMPLATE MINIMAL (Clean) --- */
        else if (d.config.template === 'minimal') {
            html = `
            <div style="${style} padding: 50px;">
                <div style="margin-bottom: 50px;">
                    <h1 style="font-size: 3em; font-weight: 300; line-height: 1; margin-bottom: 10px;">${d.personal.name}</h1>
                    <p style="font-size: 1.2em; color: ${c}; letter-spacing: 2px; text-transform: uppercase;">${d.personal.title}</p>
                </div>

                <div style="display: flex; gap: 50px;">
                    <div style="width: 65%;">
                        <div style="margin-bottom: 40px;">
                            <p style="border-left: 2px solid ${c}; padding-left: 20px; font-style: italic; color: #555;">${d.personal.summary}</p>
                        </div>

                        <div style="margin-bottom: 40px;">
                            <h3 style="font-size: 0.9em; color: #999; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px;">Esperienza</h3>
                            ${d.experience.map(e => `
                                <div style="margin-bottom: 30px;">
                                    <h4 style="font-weight: 700; font-size: 1.2em;">${e.role}</h4>
                                    <div style="color: ${c}; font-size: 0.9em; margin: 5px 0 10px;">${e.company}</div>
                                    <p style="color: #555; font-size: 0.95em;">${e.desc}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div style="flex: 1; text-align: right;">
                        <div style="margin-bottom: 40px; font-size: 0.9em; line-height: 2;">
                            <strong style="display: block; margin-bottom: 5px; color: #333;">Contatti</strong>
                            <div>${d.personal.email}</div>
                            <div>${d.personal.phone}</div>
                            <div>${d.personal.location}</div>
                        </div>

                        <div style="margin-bottom: 40px;">
                            <h3 style="font-size: 0.9em; color: #999; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Istruzione</h3>
                            ${d.education.map(e => `
                                <div style="margin-bottom: 20px;">
                                    <div style="font-weight: 700;">${e.degree}</div>
                                    <div style="font-size: 0.9em; color: #666;">${e.year}</div>
                                </div>
                            `).join('')}
                        </div>

                        <div>
                            <h3 style="font-size: 0.9em; color: #999; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Skills</h3>
                            <div style="font-size: 0.9em;">${d.skills.split(',').map(s => `<div style="margin-bottom: 5px;">${s}</div>`).join('')}</div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        /* --- TEMPLATE ELEGANT (Left Border) --- */
        else {
            html = `
            <div style="${style} padding: 40px; display: flex;">
                <div style="border-left: 15px solid ${c}; padding-left: 40px; width: 100%;">
                    <div style="margin-bottom: 40px;">
                        <h1 style="font-size: 2.8em; font-weight: 700; color: #2d3748; line-height: 1;">${d.personal.name}</h1>
                        <p style="font-size: 1.2em; color: ${c}; font-weight: 500; margin-top: 5px;">${d.personal.title}</p>
                        <div style="margin-top: 15px; font-size: 0.9em; color: #718096; display: flex; gap: 20px;">
                            <span>${d.personal.email}</span>
                            <span>${d.personal.phone}</span>
                            <span>${d.personal.location}</span>
                        </div>
                    </div>

                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <p style="color: #4a5568; line-height: 1.6;">${d.personal.summary}</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 40px;">
                        <div>
                            <h3 style="color: #2d3748; border-bottom: 2px solid ${c}; padding-bottom: 5px; margin-bottom: 20px; font-weight: 700;">Esperienza</h3>
                            ${d.experience.map(e => `
                                <div style="margin-bottom: 25px;">
                                    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px;">
                                        <h4 style="font-size: 1.1em; font-weight: 700; color: #2d3748;">${e.role}</h4>
                                        <span style="font-size: 0.8em; color: #fff; background: ${c}; padding: 2px 8px; border-radius: 4px;">${e.start} - ${e.end}</span>
                                    </div>
                                    <div style="font-size: 0.9em; font-weight: 600; color: #718096; margin-bottom: 5px;">${e.company}</div>
                                    <p style="font-size: 0.95em; color: #4a5568;">${e.desc}</p>
                                </div>
                            `).join('')}
                        </div>
                        <div>
                            <h3 style="color: #2d3748; border-bottom: 2px solid ${c}; padding-bottom: 5px; margin-bottom: 20px; font-weight: 700;">Info</h3>
                            
                            <div style="margin-bottom: 25px;">
                                <h4 style="font-size: 0.9em; text-transform: uppercase; color: #a0aec0; margin-bottom: 10px;">Formazione</h4>
                                ${d.education.map(e => `
                                    <div style="margin-bottom: 10px;">
                                        <div style="font-weight: 700; font-size: 0.95em;">${e.degree}</div>
                                        <div style="font-size: 0.85em; color: #718096;">${e.year}</div>
                                    </div>
                                `).join('')}
                            </div>

                            <div>
                                <h4 style="font-size: 0.9em; text-transform: uppercase; color: #a0aec0; margin-bottom: 10px;">Competenze</h4>
                                <div style="font-size: 0.9em; color: #4a5568; line-height: 1.6;">${d.skills}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        document.getElementById('cv-render-target').innerHTML = html;
    },

    // --- CORE LOGIC ---
    autoZoom: function() {
        const container = document.getElementById('preview-container');
        const page = document.getElementById('cv-render-target');
        if (!container || !page) return;

        const containerWidth = container.clientWidth - 40; // padding
        const pageWidth = 794; // A4 px at 96dpi
        
        let scale = containerWidth / pageWidth;
        if (scale > 1) scale = 1; // Max 100%
        
        page.style.transform = `scale(${scale})`;
        
        // Adjust height wrapper to avoid cutoff
        const scaledHeight = 1123 * scale;
        page.style.marginBottom = `-${1123 - scaledHeight}px`; // Trick to reduce whitespace
        
        // Mobile alignment
        if (window.innerWidth < 900) {
            page.style.transformOrigin = 'top center';
        } else {
            page.style.transformOrigin = 'top center';
        }
    },

    // Helper functions
    tab: function(id) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('panel-content').style.display = id === 'content' ? 'block' : 'none';
        document.getElementById('panel-design').style.display = id === 'design' ? 'block' : 'none';
    },

    bindEvents: function() {
        document.querySelectorAll('[data-model]').forEach(el => {
            el.addEventListener('input', (e) => {
                const keys = e.target.getAttribute('data-model').split('.');
                if (keys.length === 2) this.data[keys[0]][keys[1]] = e.target.value;
                else this.data[keys[0]] = e.target.value;
                this.render();
                this.save();
            });
        });
    },

    renderLists: function() {
        const expContainer = document.getElementById('list-experience');
        expContainer.innerHTML = this.data.experience.map(item => `
            <div class="dynamic-item">
                <button class="btn-del" onclick="cvApp.delItem('experience', ${item.id})"><i class="fa-solid fa-trash"></i></button>
                <input value="${item.role}" oninput="cvApp.updItem('experience', ${item.id}, 'role', this.value)" placeholder="Ruolo" style="font-weight:bold; margin-bottom:5px;">
                <input value="${item.company}" oninput="cvApp.updItem('experience', ${item.id}, 'company', this.value)" placeholder="Azienda" style="margin-bottom:5px;">
                <div class="row" style="margin-bottom:5px;">
                    <input value="${item.start}" oninput="cvApp.updItem('experience', ${item.id}, 'start', this.value)" placeholder="Dal">
                    <input value="${item.end}" oninput="cvApp.updItem('experience', ${item.id}, 'end', this.value)" placeholder="Al">
                </div>
                <textarea rows="2" oninput="cvApp.updItem('experience', ${item.id}, 'desc', this.value)" placeholder="Descrizione...">${item.desc}</textarea>
            </div>
        `).join('');

        const eduContainer = document.getElementById('list-education');
        eduContainer.innerHTML = this.data.education.map(item => `
            <div class="dynamic-item">
                <button class="btn-del" onclick="cvApp.delItem('education', ${item.id})"><i class="fa-solid fa-trash"></i></button>
                <input value="${item.degree}" oninput="cvApp.updItem('education', ${item.id}, 'degree', this.value)" placeholder="Titolo di Studio" style="font-weight:bold; margin-bottom:5px;">
                <input value="${item.school}" oninput="cvApp.updItem('education', ${item.id}, 'school', this.value)" placeholder="Istituto" style="margin-bottom:5px;">
                <input value="${item.year}" oninput="cvApp.updItem('education', ${item.id}, 'year', this.value)" placeholder="Anno">
            </div>
        `).join('');
    },

    addItem: function(type) {
        const item = type === 'experience' 
            ? { id: Date.now(), role: 'Ruolo', company: 'Azienda', start: '', end: '', desc: '' }
            : { id: Date.now(), degree: 'Titolo', school: 'Scuola', year: '' };
        this.data[type].unshift(item);
        this.save(); this.renderLists(); this.render();
    },
    delItem: function(type, id) {
        if(confirm('Rimuovere elemento?')) {
            this.data[type] = this.data[type].filter(i => i.id !== id);
            this.save(); this.renderLists(); this.render();
        }
    },
    updItem: function(type, id, field, val) {
        const item = this.data[type].find(i => i.id === id);
        if(item) item[field] = val;
        this.save(); this.render();
    },

    // Setters
    setTemplate: function(name, el) {
        this.data.config.template = name;
        document.querySelectorAll('.tpl-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        this.render(); this.save();
    },
    setColor: function(c) { this.data.config.color = c; this.render(); this.save(); },
    setFont: function(f) { this.data.config.font = f; this.render(); this.save(); },
    setScale: function(s) { this.data.config.scale = s; this.render(); this.save(); },

    // Photo
    uploadPhoto: function(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                this.data.photo = e.target.result;
                this.updatePhoto(); this.render(); this.save();
            };
            reader.readAsDataURL(input.files[0]);
        }
    },
    removePhoto: function() { this.data.photo = null; this.updatePhoto(); this.render(); this.save(); },
    updatePhoto: function() {
        const el = document.getElementById('preview-photo');
        if(this.data.photo) el.innerHTML = `<img src="${this.data.photo}" style="width:100%; height:100%; object-fit:cover;">`;
        else el.innerHTML = `<i class="fa-solid fa-user"></i>`;
    },

    // Storage
    save: function() { localStorage.setItem('cv_platinum_data', JSON.stringify(this.data)); },
    load: function() {
        const s = localStorage.getItem('cv_platinum_data');
        if(s) {
            try { this.data = JSON.parse(s); } catch(e){}
            // Riempi input
            document.querySelectorAll('[data-model]').forEach(el => {
                const k = el.getAttribute('data-model').split('.');
                el.value = k.length === 2 ? (this.data[k[0]][k[1]] || '') : (this.data[k[0]] || '');
            });
        }
    },
    reset: function() {
        if(confirm('Cancellare tutto e ricominciare?')) {
            localStorage.removeItem('cv_platinum_data');
            location.reload();
        }
    }
};

// Start
cvApp.init();
</script>

</body>
</html>
