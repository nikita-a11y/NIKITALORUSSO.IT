<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CV Creator Diamond - Crea il tuo Curriculum Perfetto</title>
    <meta name="description" content="Generatore di CV professionale gratuito. Crea, personalizza e scarica il tuo CV in PDF in pochi minuti.">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font & Icone -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700&family=Merriweather:wght@300;400;700&family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">

    <!-- Configurazione Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                        mono: ['Roboto Mono', 'monospace'],
                        poppins: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        brand: '#3b82f6',
                        dark: '#0f172a',
                        darker: '#020617',
                        surface: '#1e293b',
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(59, 130, 246, 0.5)',
                        'paper': '0 20px 50px -12px rgba(0, 0, 0, 0.5)',
                    }
                }
            }
        }
    </script>

    <style>
        /* --- STILI GLOBALI --- */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #020617; /* Sfondo applicazione scuro */
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            box-sizing: border-box;
        }

        /* Scrollbar raffinata */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* --- FOGLIO A4 (Target) --- */
        #cv-render-target {
            width: 210mm; /* A4 width default */
            min-height: 297mm; /* A4 height default */
            background-color: white; /* Fallback */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform-origin: top center;
            transition: transform 0.2s ease;
            position: relative;
            margin-bottom: 50px;
            color: #1e293b;
        }
        
        /* FIX BARRA LATERALE: Specificità aumentata per vincere su background-color: white */
        #cv-render-target.cv-sidebar-left-layout {
            /* Crea una "finta colonna" usando un gradiente che copre l'intero sfondo */
            background: linear-gradient(to right, var(--color-side-bg) 35%, white 35%);
        }

        /* Effetto pagina piegata */
        #cv-render-target::after {
            content: "";
            position: absolute;
            bottom: 15px;
            right: 10px;
            width: 50%;
            height: 20%;
            max-width: 300px;
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 15px 10px rgba(0, 0, 0, 0.3);
            transform: rotate(3deg);
            z-index: -1;
            filter: blur(10px);
        }

        /* --- STILI DI STAMPA CRITICI --- */
        @media print {
            body * { visibility: hidden; }
            
            /* Reset contenitori */
            body, html, .app-container, #preview-container {
                background: white !important;
                height: auto !important;
                width: 100% !important;
                overflow: visible !important;
                position: static !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Rendi visibile il CV */
            #cv-render-target, #cv-render-target * {
                visibility: visible;
            }

            /* Posizionamento fisso per la stampa */
            #cv-render-target {
                position: absolute;
                left: 0;
                top: 0;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                transform: none !important;
                z-index: 9999;
                min-height: 100vh; /* Forza altezza per il gradiente */
                
                /* Forza stampa colori e sfondi (Chrome/Safari/Edge) */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Rimuovi ombra pagina in stampa */
            #cv-render-target::after { display: none; }

            /* Gestione interruzioni pagina */
            .cv-section, .cv-item {
                page-break-inside: avoid;
            }

            @page { margin: 0; size: auto; }
        }
    </style>
</head>
<body>

<div id="cv-app-root" class="app-container">
    
    <!-- EDITOR (SINISTRA) -->
    <div class="w-full md:w-[460px] bg-surface border-r border-slate-700 flex-shrink-0 flex flex-col z-20 print-hidden shadow-2xl relative">
        
        <!-- HEADER -->
        <div class="p-5 border-b border-slate-700 bg-dark/80 backdrop-blur-md sticky top-0 z-30">
            <div class="flex justify-between items-center mb-4">
                <div class="text-white text-xl font-extrabold flex items-center gap-3 tracking-tight">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center text-white shadow-glow animate-pulse">
                        <i class="fa-solid fa-gem text-lg"></i>
                    </div>
                    <div>
                        <span class="block text-sm text-blue-400 font-medium uppercase tracking-wider">CV Creator</span>
                        <span class="block -mt-1 text-lg bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">Diamond</span>
                    </div>
                </div>
            </div>
            
            <!-- Azioni Rapide -->
            <div class="grid grid-cols-3 gap-2">
                <button onclick="cvApp.resetData()" class="px-3 py-2 bg-slate-800 text-slate-300 rounded-lg text-xs font-bold hover:bg-red-500/10 hover:text-red-400 hover:border-red-500/50 transition-all border border-slate-700 flex flex-col items-center gap-1 group">
                    <i class="fa-solid fa-trash-can text-sm mb-0.5 group-hover:scale-110 transition-transform"></i> Reset
                </button>
                <button onclick="cvApp.exportData()" class="px-3 py-2 bg-slate-800 text-slate-300 rounded-lg text-xs font-bold hover:bg-blue-500/10 hover:text-blue-400 hover:border-blue-500/50 transition-all border border-slate-700 flex flex-col items-center gap-1 group">
                    <i class="fa-solid fa-download text-sm mb-0.5 group-hover:scale-110 transition-transform"></i> Salva
                </button>
                <label class="px-3 py-2 bg-slate-800 text-slate-300 rounded-lg text-xs font-bold hover:bg-green-500/10 hover:text-green-400 hover:border-green-500/50 transition-all border border-slate-700 flex flex-col items-center gap-1 cursor-pointer group">
                    <i class="fa-solid fa-upload text-sm mb-0.5 group-hover:scale-110 transition-transform"></i> Carica
                    <input type="file" accept=".json" onchange="cvApp.importData(this)" class="hidden">
                </label>
            </div>
        </div>

        <!-- TABS -->
        <div class="flex px-5 pt-4 gap-2">
            <button id="tab-content" onclick="cvApp.switchTab('content', this)" class="flex-1 py-3 text-sm font-bold text-white bg-blue-600 rounded-xl shadow-lg transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2">
                <i class="fa-solid fa-pen-to-square"></i> Contenuto
            </button>
            <button id="tab-design" onclick="cvApp.switchTab('design', this)" class="flex-1 py-3 text-sm font-bold text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-700 rounded-xl transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2">
                <i class="fa-solid fa-swatchbook"></i> Design
            </button>
        </div>

        <!-- SCROLLABLE CONTENT -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-6">
            
            <!-- PANEL: CONTENT -->
            <div id="panel-content" class="space-y-8 pb-10">
                
                <!-- FOTO -->
                <div class="bg-slate-800/50 p-5 rounded-2xl border border-slate-700/50 hover:border-blue-500/30 transition-colors">
                    <div class="flex items-center gap-5">
                        <div id="preview-photo" class="w-20 h-20 rounded-full bg-slate-700 border-4 border-slate-600 flex items-center justify-center overflow-hidden shrink-0 shadow-lg group">
                            <i class="fa-solid fa-user text-slate-500 text-3xl group-hover:text-slate-400 transition-colors"></i>
                        </div>
                        <div class="flex flex-col gap-2 w-full">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Foto Profilo</h3>
                            <div class="flex gap-2">
                                <input type="file" id="upload-photo" accept="image/*" style="display: none;" onchange="cvApp.uploadPhoto(this)">
                                <button onclick="document.getElementById('upload-photo').click()" class="flex-1 bg-slate-700 hover:bg-blue-600 text-white text-xs font-bold py-2 rounded-lg transition-colors">
                                    Carica
                                </button>
                                <button onclick="cvApp.removePhoto()" class="flex-1 bg-slate-700 hover:bg-red-500/20 hover:text-red-400 text-slate-300 text-xs font-bold py-2 rounded-lg transition-colors border border-transparent hover:border-red-500/50">
                                    Rimuovi
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INFO -->
                <div class="space-y-4">
                    <div class="relative group">
                        <label class="text-[10px] font-bold text-blue-400 uppercase ml-1 mb-1 block">Chi sei</label>
                        <input type="text" data-model="personal.name" placeholder="Mario Rossi" class="w-full bg-slate-900 border border-slate-700 text-white rounded-xl p-3.5 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 focus:outline-none placeholder-slate-600 transition-all font-semibold">
                    </div>
                    <div>
                        <input type="text" data-model="personal.title" placeholder="Titolo (es. Web Designer)" class="w-full bg-slate-900 border border-slate-700 text-white rounded-xl p-3.5 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 focus:outline-none placeholder-slate-600">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" data-model="personal.email" placeholder="Email" class="bg-slate-900 border border-slate-700 text-white rounded-xl p-3 text-sm focus:border-blue-500 focus:outline-none placeholder-slate-600">
                        <input type="text" data-model="personal.phone" placeholder="Telefono" class="bg-slate-900 border border-slate-700 text-white rounded-xl p-3 text-sm focus:border-blue-500 focus:outline-none placeholder-slate-600">
                    </div>
                    <input type="text" data-model="personal.location" placeholder="Indirizzo / Città" class="w-full bg-slate-900 border border-slate-700 text-white rounded-xl p-3 text-sm focus:border-blue-500 focus:outline-none placeholder-slate-600">
                </div>

                <div class="bg-slate-800/30 p-1 rounded-xl">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2 mb-1 mt-2 block">Profilo (Bio)</label>
                    <textarea data-model="personal.summary" rows="4" class="w-full bg-slate-900 border border-slate-700 text-white rounded-xl p-3 text-sm focus:border-blue-500 focus:outline-none placeholder-slate-600 resize-none leading-relaxed" placeholder="Scrivi una breve introduzione su di te..."></textarea>
                </div>

                <!-- LISTE -->
                <div class="bg-slate-800/30 p-5 rounded-2xl border border-slate-700/50">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-xs font-bold text-slate-300 uppercase flex items-center gap-2"><i class="fa-solid fa-briefcase text-blue-500"></i> Esperienza</label>
                        <button onclick="cvApp.addItem('experience')" class="text-xs bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-white font-bold px-3 py-1.5 rounded-lg transition-all border border-blue-500/20 hover:border-blue-500 shadow-sm">+ Aggiungi</button>
                    </div>
                    <div id="list-experience" class="space-y-4"></div>
                </div>

                <div class="bg-slate-800/30 p-5 rounded-2xl border border-slate-700/50">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-xs font-bold text-slate-300 uppercase flex items-center gap-2"><i class="fa-solid fa-graduation-cap text-green-500"></i> Istruzione</label>
                        <button onclick="cvApp.addItem('education')" class="text-xs bg-green-500/10 text-green-400 hover:bg-green-500 hover:text-white font-bold px-3 py-1.5 rounded-lg transition-all border border-green-500/20 hover:border-green-500 shadow-sm">+ Aggiungi</button>
                    </div>
                    <div id="list-education" class="space-y-4"></div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">Competenze & Lingue</label>
                    <textarea data-model="skills" rows="3" class="w-full bg-slate-900 border border-slate-700 text-white rounded-xl p-3 text-sm focus:border-blue-500 focus:outline-none placeholder-slate-600 resize-none" placeholder="HTML, CSS, Leadership, Spagnolo..."></textarea>
                </div>
            </div>

            <!-- PANEL: DESIGN -->
            <div id="panel-design" style="display: none;" class="space-y-8 pb-10">
                
                <!-- LAYOUT -->
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-3 block">Scegli il tuo stile</label>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="cvApp.setLayout('sidebarLeft', this)" class="tpl-card active bg-slate-800 border-2 border-blue-500 rounded-xl p-3 text-center text-white hover:bg-slate-700 transition-all group relative overflow-hidden">
                            <div class="absolute inset-0 bg-blue-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="h-14 w-full bg-slate-700 rounded-lg mb-2 flex overflow-hidden border border-slate-600 group-hover:border-blue-400/50 shadow-sm"><div class="w-1/3 bg-blue-500 h-full"></div><div class="w-2/3 bg-white h-full opacity-10"></div></div>
                            <span class="text-[10px] font-bold uppercase tracking-wider">Modern</span>
                        </button>
                        <button onclick="cvApp.setLayout('classic', this)" class="tpl-card bg-slate-800 border-2 border-transparent rounded-xl p-3 text-center text-slate-400 hover:bg-slate-700 transition-all group relative overflow-hidden">
                            <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="h-14 w-full bg-slate-700 rounded-lg mb-2 flex flex-col border border-slate-600 group-hover:border-slate-500 shadow-sm"><div class="w-full h-4 bg-slate-500/50 border-b border-slate-600"></div></div>
                            <span class="text-[10px] font-bold uppercase tracking-wider">Classic</span>
                        </button>
                        <button onclick="cvApp.setLayout('minimal', this)" class="tpl-card bg-slate-800 border-2 border-transparent rounded-xl p-3 text-center text-slate-400 hover:bg-slate-700 transition-all group relative overflow-hidden">
                            <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="h-14 w-full bg-slate-700 rounded-lg mb-2 flex border border-slate-600 group-hover:border-slate-500 shadow-sm"><div class="w-full h-full border-l-4 border-slate-500/50 ml-3"></div></div>
                            <span class="text-[10px] font-bold uppercase tracking-wider">Minimal</span>
                        </button>
                    </div>
                </div>

                <!-- CARTA -->
                <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <label class="text-xs font-bold text-slate-400 uppercase mb-3 block">Formato Foglio</label>
                    <div class="flex gap-2 bg-slate-900 p-1.5 rounded-lg border border-slate-700">
                        <button onclick="cvApp.setPaper('A4')" id="btn-a4" class="flex-1 py-2 text-xs font-bold text-white bg-slate-700 rounded-md shadow-sm transition-all">A4 (Standard)</button>
                        <button onclick="cvApp.setPaper('Letter')" id="btn-letter" class="flex-1 py-2 text-xs font-bold text-slate-400 hover:text-white transition-all">Letter (US)</button>
                    </div>
                </div>
                
                <!-- COLORI -->
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-3 block">Colori Personalizzati</label>
                    <div class="bg-slate-800 p-5 rounded-xl border border-slate-700 space-y-5">
                        <div class="flex justify-between items-center group">
                            <span class="text-sm text-slate-300 font-medium group-hover:text-white transition-colors">Colore Accento</span>
                            <div class="relative w-10 h-10 rounded-full overflow-hidden border-2 border-white ring-2 ring-slate-700 cursor-pointer shadow-md hover:scale-110 transition-transform">
                                <input type="color" data-model="config.color" oninput="cvApp.setConfig('color', this.value)" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[150%] h-[150%] p-0 m-0 border-none cursor-pointer">
                            </div>
                        </div>
                        <div class="h-px bg-slate-700"></div>
                        <div class="flex justify-between items-center group">
                            <span class="text-sm text-slate-300 font-medium group-hover:text-white transition-colors">Sfondo Colonna</span>
                            <div class="relative w-10 h-10 rounded-full overflow-hidden border-2 border-white ring-2 ring-slate-700 cursor-pointer shadow-md hover:scale-110 transition-transform">
                                <input type="color" data-model="config.sidebarBg" oninput="cvApp.setConfig('sidebarBg', this.value)" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[150%] h-[150%] p-0 m-0 border-none cursor-pointer">
                            </div>
                        </div>
                        <div class="h-px bg-slate-700"></div>
                        <div class="flex justify-between items-center group">
                            <span class="text-sm text-slate-300 font-medium group-hover:text-white transition-colors">Testo Colonna</span>
                            <div class="relative w-10 h-10 rounded-full overflow-hidden border-2 border-white ring-2 ring-slate-700 cursor-pointer shadow-md hover:scale-110 transition-transform">
                                <input type="color" data-model="config.sideText" oninput="cvApp.setConfig('sideText', this.value)" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[150%] h-[150%] p-0 m-0 border-none cursor-pointer">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TIPOGRAFIA -->
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-3 block">Carattere</label>
                    <select data-model="config.font" onchange="cvApp.setConfig('font', this.value)" class="w-full bg-slate-900 border border-slate-700 text-white rounded-xl p-3 text-sm focus:border-blue-500 focus:outline-none">
                        <option value="Inter, sans-serif">Inter (Standard Pulito)</option>
                        <option value="Poppins, sans-serif">Poppins (Moderno Geometrico)</option>
                        <option value="Merriweather, serif">Merriweather (Elegante Serale)</option>
                        <option value="Roboto Mono, monospace">Roboto Mono (Tecnico)</option>
                    </select>
                </div>

                <!-- SCALA -->
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-3 block flex justify-between">Dimensione Testo <span id="scale-val" class="text-blue-400 font-mono">100%</span></label>
                    <div class="px-2">
                        <input type="range" min="0.8" max="1.2" step="0.05" value="1" oninput="cvApp.setConfig('scale', this.value); document.getElementById('scale-val').innerText = Math.round(this.value*100) + '%'" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500 hover:accent-blue-400">
                    </div>
                </div>

            </div>

        </div>

        <!-- FOOTER -->
        <div class="p-6 bg-dark/95 backdrop-blur border-t border-slate-700 print-hidden">
            <button onclick="window.print()" class="w-full px-4 py-4 bg-gradient-to-r from-blue-600 via-blue-500 to-indigo-600 text-white rounded-xl font-bold text-lg hover:from-blue-500 hover:to-indigo-500 transition-all shadow-glow flex items-center justify-center gap-3 transform hover:-translate-y-1 active:translate-y-0 active:shadow-none border border-white/10 group">
                <span class="bg-white/20 p-1 rounded-full group-hover:rotate-12 transition-transform"><i class="fa-solid fa-file-pdf"></i></span> Scarica il tuo CV
            </button>
        </div>
    </div>

    <!-- PREVIEW (DESTRA) -->
    <div id="preview-container" class="flex-1 bg-slate-900 relative overflow-hidden flex justify-center items-start pt-12 px-4 print-hidden bg-[radial-gradient(#1e293b_1px,transparent_1px)] [background-size:20px_20px]">
        
        <!-- Zoom Badge -->
        <div class="absolute top-6 right-6 bg-slate-800/90 text-white text-xs font-bold px-4 py-2 rounded-full backdrop-blur-md border border-slate-600 shadow-xl flex items-center gap-2 z-10 hover:bg-slate-700 transition-colors cursor-default">
            <i class="fa-solid fa-magnifying-glass text-blue-400"></i> <span id="zoom-level">100%</span>
        </div>

        <!-- CV CONTAINER (A4) -->
        <div id="cv-render-target" class="bg-white text-slate-900">
            <!-- Il contenuto del CV viene iniettato qui da JS -->
        </div>

    </div>

</div>

<!-- LOGICA JS -->
<script>
    const cvApp = {
        data: {
            personal: { name: 'Giulia Bianchi', title: 'Senior UX Designer', email: 'giulia.ux@example.com', phone: '+39 340 1234567', location: 'Roma, Italia', summary: 'Designer creativa con passione per l\'accessibilità e le interfacce intuitive. Oltre 6 anni di esperienza nella creazione di prodotti digitali centrati sull\'utente.' },
            experience: [{ id: 1, role: 'Lead Designer', company: 'Creative Studio', start: '2021', end: 'Presente', desc: 'Guido un team di 4 designer. Ho ridisegnato la UX della piattaforma principale aumentando la retention del 25%.' }],
            education: [{ id: 1, degree: 'Laurea Magistrale in Design', school: 'Politecnico di Milano', year: '2020' }],
            skills: 'Figma, Adobe XD, HTML/CSS, User Research, Prototyping, Agile',
            photo: null,
            config: { template: 'sidebarLeft', color: '#3b82f6', font: 'Inter, sans-serif', scale: 1, sidebarBg: '#1e293b', sideText: '#ffffff', paper: 'A4' }
        },
        
        init: function() {
            this.loadData();
            this.bindInputEvents();
            this.renderLists();
            this.updatePhotoPreview();
            this.updatePaperUI();
            this.render();
            
            // Auto-Zoom (Responsive)
            const observer = new ResizeObserver(() => this.autoScale());
            const container = document.getElementById('preview-container');
            if(container) observer.observe(container);
            setTimeout(() => this.autoScale(), 200);
        },

        // --- GESTIONE DATI (Export/Import) ---
        loadData: function() {
            const saved = localStorage.getItem('cv_diamond_v2');
            if (saved) {
                try {
                    const loaded = JSON.parse(saved);
                    // Merge profondo per sicurezza
                    this.data = {...this.data, ...loaded, config: {...this.data.config, ...loaded.config}};
                } catch(e) {}
            }
        },
        saveData: function() { localStorage.setItem('cv_diamond_v2', JSON.stringify(this.data)); },
        
        resetData: function() {
            if(confirm('Sei sicuro? Tutti i dati verranno cancellati.')) {
                localStorage.removeItem('cv_diamond_v2');
                location.reload();
            }
        },

        exportData: function() {
            const dataStr = JSON.stringify(this.data, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CV_${this.data.personal.name.replace(/\s+/g, '_')}.json`;
            a.click();
        },

        importData: function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    this.data = {...this.data, ...imported};
                    this.saveData();
                    // Reload UI
                    this.bindInputEvents(); // Refresh input values
                    this.renderLists();
                    this.updatePhotoPreview();
                    this.render();
                    alert('Dati caricati con successo!');
                } catch (err) {
                    alert('Errore nel file JSON.');
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset input
        },

        bindInputEvents: function() {
            document.querySelectorAll('[data-model]').forEach(input => {
                const [p, k] = input.getAttribute('data-model').split('.');
                input.value = k ? (this.data[p][k] || '') : (this.data[p] || '');
                
                // Remove old listeners to avoid duplicates on re-bind
                input.oninput = (e) => {
                    if (k) this.data[p][k] = e.target.value;
                    else this.data[p] = e.target.value;
                    this.saveData(); this.render();
                };
            });
        },

        setConfig: function(k, v) { this.data.config[k] = v; this.saveData(); this.render(); },
        
        setLayout: function(tpl, btn) {
            this.data.config.template = tpl;
            document.querySelectorAll('.tpl-card').forEach(b => {
                b.classList.remove('active', 'border-blue-500', 'text-white');
                b.classList.add('border-transparent', 'text-slate-400');
            });
            btn.classList.add('active', 'border-blue-500', 'text-white');
            this.saveData(); this.render();
        },

        setPaper: function(size) {
            this.data.config.paper = size;
            this.updatePaperUI();
            this.saveData();
            this.render();
            this.autoScale(); // Re-calc zoom
        },

        updatePaperUI: function() {
            const size = this.data.config.paper || 'A4';
            const btnA4 = document.getElementById('btn-a4');
            const btnLet = document.getElementById('btn-letter');
            
            if(size === 'A4') {
                btnA4.classList.add('bg-slate-700', 'text-white'); btnA4.classList.remove('text-slate-400');
                btnLet.classList.remove('bg-slate-700', 'text-white'); btnLet.classList.add('text-slate-400');
            } else {
                btnLet.classList.add('bg-slate-700', 'text-white'); btnLet.classList.remove('text-slate-400');
                btnA4.classList.remove('bg-slate-700', 'text-white'); btnA4.classList.add('text-slate-400');
            }
        },

        // --- LISTE ---
        addItem: function(type) {
            const item = type === 'experience' 
                ? { id: Date.now(), role: 'Nuovo Ruolo', company: 'Azienda', start: '', end: '', desc: '' }
                : { id: Date.now(), degree: 'Titolo', school: 'Istituto', year: '' };
            this.data[type].unshift(item);
            this.saveData(); this.renderLists(); this.render();
        },
        removeItem: function(type, id) {
            if(confirm('Rimuovere?')) {
                this.data[type] = this.data[type].filter(i => i.id !== id);
                this.saveData(); this.renderLists(); this.render();
            }
        },
        updateList: function(type, id, key, val) {
            const item = this.data[type].find(i => i.id === id);
            if(item) item[key] = val;
            this.saveData(); this.render();
        },
        renderLists: function() {
            document.getElementById('list-experience').innerHTML = this.data.experience.map(i => `
                <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 relative group transition-all hover:border-blue-500/50 hover:shadow-lg">
                    <button onclick="cvApp.removeItem('experience', ${i.id})" class="absolute top-3 right-3 text-slate-600 hover:text-red-400 transition-colors p-1"><i class="fa-solid fa-trash-can"></i></button>
                    <input class="bg-transparent text-white font-bold w-full mb-1.5 text-sm focus:outline-none border-b border-transparent focus:border-blue-500" value="${i.role}" oninput="cvApp.updateList('experience', ${i.id}, 'role', this.value)" placeholder="Ruolo">
                    <input class="bg-transparent text-blue-400 w-full text-xs mb-3 focus:outline-none" value="${i.company}" oninput="cvApp.updateList('experience', ${i.id}, 'company', this.value)" placeholder="Azienda">
                    <div class="flex gap-2 mb-3">
                        <input class="bg-slate-800 text-white rounded-lg text-xs p-2 w-1/2 focus:outline-none border border-slate-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" value="${i.start}" oninput="cvApp.updateList('experience', ${i.id}, 'start', this.value)" placeholder="Dal">
                        <input class="bg-slate-800 text-white rounded-lg text-xs p-2 w-1/2 focus:outline-none border border-slate-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" value="${i.end}" oninput="cvApp.updateList('experience', ${i.id}, 'end', this.value)" placeholder="Al">
                    </div>
                    <textarea class="bg-slate-800 text-slate-300 rounded-lg text-xs p-2.5 w-full resize-none focus:outline-none border border-slate-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" rows="2" oninput="cvApp.updateList('experience', ${i.id}, 'desc', this.value)" placeholder="Descrizione...">${i.desc}</textarea>
                </div>
            `).join('');
            
            document.getElementById('list-education').innerHTML = this.data.education.map(i => `
                <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 relative group transition-all hover:border-blue-500/50 hover:shadow-lg">
                    <button onclick="cvApp.removeItem('education', ${i.id})" class="absolute top-3 right-3 text-slate-600 hover:text-red-400 transition-colors p-1"><i class="fa-solid fa-trash-can"></i></button>
                    <input class="bg-transparent text-white font-bold w-full mb-1.5 text-sm focus:outline-none border-b border-transparent focus:border-blue-500" value="${i.degree}" oninput="cvApp.updateList('education', ${i.id}, 'degree', this.value)" placeholder="Titolo">
                    <input class="bg-transparent text-blue-400 w-full text-xs mb-2 focus:outline-none" value="${i.school}" oninput="cvApp.updateList('education', ${i.id}, 'school', this.value)" placeholder="Istituto">
                    <input class="bg-slate-800 text-white rounded-lg text-xs p-2 w-full focus:outline-none border border-slate-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" value="${i.year}" oninput="cvApp.updateList('education', ${i.id}, 'year', this.value)" placeholder="Anno">
                </div>
            `).join('');
        },

        // --- FOTO ---
        uploadPhoto: function(el) {
            const file = el.files[0];
            if(file) {
                const r = new FileReader();
                r.onload = (e) => { this.data.photo = e.target.result; this.saveData(); this.updatePhotoPreview(); this.render(); };
                r.readAsDataURL(file);
            }
        },
        removePhoto: function() { this.data.photo = null; this.saveData(); this.updatePhotoPreview(); this.render(); },
        updatePhotoPreview: function() {
            const div = document.getElementById('preview-photo');
            div.innerHTML = this.data.photo ? `<img src="${this.data.photo}" class="w-full h-full object-cover">` : `<i class="fa-solid fa-user text-slate-500 text-3xl"></i>`;
        },

        // --- RENDER CV HTML ---
        render: function() {
            const d = this.data;
            const c = d.config;
            const target = document.getElementById('cv-render-target');
            
            // Imposta Dimensione Foglio
            if (c.paper === 'Letter') {
                target.style.width = '215.9mm';
                target.style.minHeight = '279.4mm';
            } else {
                target.style.width = '210mm';
                target.style.minHeight = '297mm';
            }

            // Imposta variabili CSS
            target.style.setProperty('--color-primary', c.color);
            target.style.setProperty('--color-side-bg', c.sidebarBg);
            target.style.setProperty('--color-side-text', c.sideText || '#ffffff');
            target.style.setProperty('--color-text', c.textColor);
            target.style.fontFamily = c.font;
            target.style.fontSize = `${14 * c.scale}px`;

            // Reset classi
            target.className = `cv-page ${c.font.includes('Poppins') ? 'font-poppins' : c.font.includes('Merriweather') ? 'font-serif' : c.font.includes('Roboto Mono') ? 'font-mono' : 'font-sans'}`;
            
            // Aggiungi classe speciale per il layout Moderno per gestire il background gradient
            if(c.template === 'sidebarLeft') target.classList.add('cv-sidebar-left-layout');
            else target.classList.remove('cv-sidebar-left-layout');

            let html = '';
            const skillsArr = d.skills.split(',').filter(s => s.trim() !== '');
            
            // 1. MODERN (Sidebar Left) - Il gradiente è gestito via CSS su #cv-render-target
            if (c.template === 'sidebarLeft') {
                html = `
                <div class="flex h-full min-h-[inherit]">
                    <div class="w-[35%] text-[var(--color-side-text)] p-8 flex flex-col shrink-0">
                        <div class="text-center mb-10">
                            ${d.photo ? `<div class="w-36 h-36 mx-auto mb-5 rounded-full bg-cover bg-center border-[5px] border-white/20 shadow-xl" style="background-image:url('${d.photo}')"></div>` : `<div class="w-24 h-24 mx-auto mb-4 rounded-full bg-white/20 flex items-center justify-center text-3xl font-bold shadow-inner">${d.personal.name.charAt(0)}</div>`}
                            <h1 class="text-2xl font-bold leading-tight mb-2 break-words drop-shadow-md">${d.personal.name}</h1>
                            <p class="opacity-90 text-sm uppercase tracking-wider font-medium">${d.personal.title}</p>
                        </div>

                        <div class="space-y-4 text-sm mb-10 opacity-95">
                            <div class="text-xs font-bold uppercase tracking-widest border-b border-white/30 pb-2 mb-4 opacity-80">Contatti</div>
                            <div class="flex items-center gap-3"><i class="fa-solid fa-envelope w-4"></i> <span class="break-all font-light">${d.personal.email}</span></div>
                            <div class="flex items-center gap-3"><i class="fa-solid fa-phone w-4"></i> <span class="font-light">${d.personal.phone}</span></div>
                            <div class="flex items-center gap-3"><i class="fa-solid fa-location-dot w-4"></i> <span class="font-light">${d.personal.location}</span></div>
                        </div>

                        <div class="mt-auto">
                            <div class="text-xs font-bold uppercase tracking-widest border-b border-white/30 pb-2 mb-4 opacity-80">Competenze</div>
                            <div class="flex flex-wrap gap-2">
                                ${skillsArr.map(s => `<span class="bg-white/10 px-2.5 py-1 rounded-md text-xs font-medium backdrop-blur-sm">${s.trim()}</span>`).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="w-[65%] p-10 bg-white text-[var(--color-text)]">
                        <section class="mb-10">
                            <h3 class="uppercase text-lg font-bold border-b-[3px] pb-2 mb-5 tracking-widest text-[var(--color-primary)] flex items-center gap-2" style="border-color: ${c.color}20;">
                                <i class="fa-solid fa-user text-sm opacity-50"></i> Profilo
                            </h3>
                            <p class="opacity-80 text-justify leading-relaxed text-[0.95em]">${d.personal.summary}</p>
                        </section>

                        <section class="mb-10">
                            <h3 class="uppercase text-lg font-bold border-b-[3px] pb-2 mb-6 tracking-widest text-[var(--color-primary)] flex items-center gap-2" style="border-color: ${c.color}20;">
                                <i class="fa-solid fa-briefcase text-sm opacity-50"></i> Esperienza
                            </h3>
                            <div class="space-y-8">
                                ${d.experience.map(e => `
                                    <div class="relative pl-6 border-l-2 border-slate-100 group">
                                        <div class="absolute -left-[5px] top-1.5 w-2 h-2 rounded-full bg-[var(--color-primary)] ring-4 ring-white"></div>
                                        <div class="flex justify-between items-baseline mb-1">
                                            <h4 class="font-bold text-lg leading-tight group-hover:text-[var(--color-primary)] transition-colors">${e.role}</h4>
                                            <span class="text-xs font-bold bg-slate-50 px-2 py-1 rounded text-slate-500 border border-slate-100 whitespace-nowrap ml-2">${e.start} - ${e.end}</span>
                                        </div>
                                        <div class="text-sm font-bold mb-2 text-[var(--color-primary)] opacity-80">${e.company}</div>
                                        <p class="opacity-70 text-sm whitespace-pre-line leading-relaxed">${e.desc}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </section>

                        <section>
                            <h3 class="uppercase text-lg font-bold border-b-[3px] pb-2 mb-6 tracking-widest text-[var(--color-primary)] flex items-center gap-2" style="border-color: ${c.color}20;">
                                <i class="fa-solid fa-graduation-cap text-sm opacity-50"></i> Formazione
                            </h3>
                            <div class="space-y-5">
                                ${d.education.map(e => `
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-bold text-[1em]">${e.degree}</div>
                                            <div class="text-sm opacity-60 mt-0.5">${e.school}</div>
                                        </div>
                                        <div class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded">${e.year}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    </div>
                </div>`;
            } 
            /* --- TEMPLATE CLASSIC --- */
            else if (c.template === 'classic') {
                html = `
                <div class="p-12 h-full bg-white text-[var(--color-text)]">
                    <div class="text-center border-b border-slate-200 pb-10 mb-10">
                        ${d.photo ? `<div class="w-28 h-28 mx-auto mb-6 rounded-full bg-cover bg-center shadow-lg" style="background-image: url('${d.photo}');"></div>` : ''}
                        <h1 class="text-5xl font-bold uppercase tracking-tight mb-3 text-slate-800">${d.personal.name}</h1>
                        <p class="text-xl font-medium mb-6 text-[var(--color-primary)] tracking-wide">${d.personal.title}</p>
                        <div class="flex justify-center gap-6 text-sm text-slate-500 font-medium">
                            <span class="flex items-center gap-2"><i class="fa-solid fa-envelope opacity-50"></i> ${d.personal.email}</span>
                            <span class="flex items-center gap-2"><i class="fa-solid fa-phone opacity-50"></i> ${d.personal.phone}</span>
                            <span class="flex items-center gap-2"><i class="fa-solid fa-location-dot opacity-50"></i> ${d.personal.location}</span>
                        </div>
                    </div>

                    <section class="mb-10">
                        <h3 class="uppercase font-bold text-sm tracking-widest border-b border-slate-200 mb-4 pb-2 text-slate-400">Profilo</h3>
                        <p class="opacity-80 leading-relaxed text-justify">${d.personal.summary}</p>
                    </section>

                    <section class="mb-10">
                        <h3 class="uppercase font-bold text-sm tracking-widest border-b border-slate-200 mb-6 pb-2 text-slate-400">Esperienza Professionale</h3>
                        ${d.experience.map(e => `
                            <div class="grid grid-cols-[1fr_3fr] gap-8 mb-8">
                                <div class="text-right pt-1">
                                    <div class="text-sm font-bold text-[var(--color-primary)]">${e.start} - ${e.end}</div>
                                    <div class="text-xs text-slate-400 font-medium mt-1 uppercase">${e.location || 'Sede'}</div>
                                </div>
                                <div>
                                    <h4 class="font-bold text-xl text-slate-800 mb-1">${e.role}</h4>
                                    <div class="text-sm font-semibold text-slate-500 mb-3">${e.company}</div>
                                    <p class="opacity-80 text-sm leading-relaxed">${e.desc}</p>
                                </div>
                            </div>
                        `).join('')}
                    </section>

                    <div class="grid grid-cols-2 gap-12">
                        <section>
                            <h3 class="uppercase font-bold text-sm tracking-widest border-b border-slate-200 mb-5 pb-2 text-slate-400">Istruzione</h3>
                            ${d.education.map(e => `
                                <div class="mb-5">
                                    <div class="font-bold text-lg text-slate-800">${e.degree}</div>
                                    <div class="text-sm text-[var(--color-primary)] font-medium mt-1">${e.school}</div>
                                    <div class="text-xs text-slate-400 mt-1">${e.year}</div>
                                </div>
                            `).join('')}
                        </section>
                        <section>
                            <h3 class="uppercase font-bold text-sm tracking-widest border-b border-slate-200 mb-5 pb-2 text-slate-400">Competenze</h3>
                            <div class="flex flex-wrap gap-2">
                                ${skillsArr.map(s => `<span class="bg-slate-100 text-slate-600 px-3 py-1.5 rounded text-xs font-bold border border-slate-200">${s.trim()}</span>`).join('')}
                            </div>
                        </section>
                    </div>
                </div>`;
            }
            /* --- TEMPLATE MINIMAL --- */
            else {
                html = `
                <div class="p-12 h-full bg-white text-[var(--color-text)] grid grid-cols-[3fr_1fr] gap-16">
                    <div>
                        <div class="mb-16">
                            <h1 class="text-6xl font-light mb-4 leading-none tracking-tight text-slate-900">${d.personal.name}</h1>
                            <p class="text-xl uppercase tracking-[0.2em] font-bold text-[var(--color-primary)]">${d.personal.title}</p>
                        </div>

                        <div class="mb-12 border-l-4 pl-6 py-1" style="border-color: var(--color-primary)">
                            <p class="text-lg italic text-slate-600 font-serif leading-relaxed opacity-90">${d.personal.summary}</p>
                        </div>

                        <section>
                            <h3 class="text-xs font-bold uppercase text-slate-400 tracking-[0.2em] mb-8 flex items-center gap-4">
                                Esperienza <span class="h-px bg-slate-200 flex-1"></span>
                            </h3>
                            <div class="space-y-10">
                                ${d.experience.map(e => `
                                    <div class="group">
                                        <h4 class="text-2xl font-bold text-slate-800 mb-1 group-hover:text-[var(--color-primary)] transition-colors">${e.role}</h4>
                                        <div class="text-sm font-bold mb-4 text-[var(--color-primary)] opacity-80 flex items-center gap-2">
                                            ${e.company} <span class="w-1 h-1 rounded-full bg-slate-300"></span> ${e.start} - ${e.end}
                                        </div>
                                        <p class="opacity-80 text-sm leading-7 text-slate-600">${e.desc}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    </div>

                    <div class="text-right pt-4">
                        ${d.photo ? `<div class="w-32 h-32 ml-auto mb-10 bg-cover bg-center grayscale shadow-lg rounded-sm" style="background-image: url('${d.photo}')"></div>` : ''}

                        <div class="mb-12">
                            <h3 class="text-[10px] font-bold uppercase text-slate-400 tracking-widest mb-4 border-b border-slate-100 pb-2">Contatti</h3>
                            <div class="space-y-2 text-sm font-medium text-slate-700">
                                <div class="break-all hover:text-[var(--color-primary)] transition-colors cursor-pointer">${d.personal.email}</div>
                                <div>${d.personal.phone}</div>
                                <div>${d.personal.location}</div>
                            </div>
                        </div>

                        <div class="mb-12">
                            <h3 class="text-[10px] font-bold uppercase text-slate-400 tracking-widest mb-4 border-b border-slate-100 pb-2">Istruzione</h3>
                            ${d.education.map(e => `
                                <div class="mb-6">
                                    <div class="font-bold text-slate-800 leading-tight">${e.degree}</div>
                                    <div class="text-xs text-[var(--color-primary)] mt-1 font-bold">${e.school}</div>
                                    <div class="text-xs text-slate-400 mt-1">${e.year}</div>
                                </div>
                            `).join('')}
                        </div>

                        <div>
                            <h3 class="text-[10px] font-bold uppercase text-slate-400 tracking-widest mb-4 border-b border-slate-100 pb-2">Skills</h3>
                            <div class="flex flex-wrap justify-end gap-2">
                                ${skillsArr.map((s, i) => `<span class="border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 bg-slate-50">${s.trim()}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            
            target.innerHTML = html;
        },

        autoScale: function() {
            const container = document.getElementById('preview-container');
            const page = document.getElementById('cv-render-target');
            if(!container || !page) return;
            
            const paperWidth = this.data.config.paper === 'Letter' ? 816 : 794; // approx px 96dpi
            const availW = container.clientWidth - 40;
            const scale = Math.min(availW / paperWidth, 1); 
            
            page.style.transform = `scale(${scale})`;
            
            // Adjust height container to remove empty space below scaled element
            const pageHeight = this.data.config.paper === 'Letter' ? 1056 : 1123;
            page.style.marginBottom = `-${pageHeight - (pageHeight * scale)}px`; 
            
            document.getElementById('zoom-level').innerText = `${Math.round(scale*100)}%`;
        },

        switchTab: function(t, btn) {
            document.querySelectorAll('#tab-content, #tab-design').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                b.classList.add('bg-slate-800', 'text-slate-400', 'hover:bg-slate-700', 'hover:text-white');
            });
            btn.classList.remove('bg-slate-800', 'text-slate-400', 'hover:bg-slate-700', 'hover:text-white');
            btn.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
            document.getElementById('panel-content').style.display = t === 'content' ? 'block' : 'none';
            document.getElementById('panel-design').style.display = t === 'design' ? 'block' : 'none';
        }
    };

    document.addEventListener('DOMContentLoaded', () => cvApp.init());
</script>

</body>
</html>
